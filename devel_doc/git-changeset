#!/bin/bash

gitdir=$(git rev-parse --path-format=absolute --git-common-dir)
commit=$1
dir=${gitdir}/changeset/commits/${commit:0:2}
path=${dir}/${commit:2}

mkdir -p $dir

if [ ! -e "${path}" ]; then
    echo >&2 "Fetching changeset for commit $commit"
    json=$(gh pr list --state merged --limit 1 \
           --json number,title,url,labels --search ${commit}) || exit 1
    if [ "${json}" == "[]" ] || \
         echo "${json}" | jq -r ".[].labels[].name" | grep -q '^release$'; then
        touch ${path}
        exit 1
    fi
    number=$(echo "${json}" | jq ".[].number")
    title=$(echo "${json}" | jq -r ".[].title")
    labels=$(echo "${json}" | jq -r ".[].labels[].name" | xargs)
    mkdir -p ${dir} ${gitdir}/changeset/numbers
    echo -e "${title}\n${labels}" > ${gitdir}/changeset/numbers/${number}
    ln -s ../../numbers/${number} ${path}
fi

if [ -L "${path}" ]; then
    file=$(readlink -f ${path})
    number=$(basename ${file})
    echo -n "PR #${number}: "
    cat ${file} | sed -n "1p"
    cat ${file} | sed -n "2p"
    echo "https://github.com/rpm-software-management/rpm/pull/${number}"
fi
